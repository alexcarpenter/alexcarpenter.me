---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection, render } from "astro:content";

const entries = await getCollection("changelog");
const renderedEntries = await Promise.all(
  entries.map(async (entry) => {
    const { Content } = await render(entry);
    return { entry, Content };
  }),
);

function parseVersion(version: string) {
  const parts = version.split(".").map(Number);
  return {
    major: parts[0] || 0,
    minor: parts[1] || 0,
    patch: parts[2] || 0,
    full: version,
  };
}

const groupedByMajor = renderedEntries.reduce(
  (acc, { entry, Content }) => {
    const parsed = parseVersion(entry.data.version);
    const major = parsed.major;

    if (!acc[major]) {
      acc[major] = [];
    }

    acc[major].push({ entry, Content, parsed });
    return acc;
  },
  {} as Record<
    number,
    Array<{ entry: any; Content: any; parsed: ReturnType<typeof parseVersion> }>
  >,
);

const sortedMajorVersions = Object.keys(groupedByMajor)
  .map(Number)
  .sort((a, b) => b - a);

sortedMajorVersions.forEach((major) => {
  groupedByMajor[major].sort((a, b) => {
    if (b.parsed.minor !== a.parsed.minor) {
      return b.parsed.minor - a.parsed.minor;
    }
    return b.parsed.patch - a.parsed.patch;
  });
});

const meta = {
  title: "Changelog",
  description:
    "All notable changes to this project will be documented in this file.",
};
---

<BaseLayout title={meta.title} description={meta.description}>
  <article class="container mt-4">
    <header>
      <h1
        class="max-w-[40ch] text-2xl leading-tight font-medium tracking-tight"
      >
        {meta.title}
      </h1>
      <p
        class="text-muted-foreground mt-4 max-w-[55ch] font-medium text-pretty"
      >
        {meta.description}
      </p>
    </header>
    <ol class="mt-8 space-y-8">
      {
        sortedMajorVersions.map((major) => {
          const versions = groupedByMajor[major];
          const latestVersion = versions[0];
          return (
            <li class="grid grid-cols-1 gap-x-8 sm:grid-cols-[25%_1fr]">
              <div class="text-muted-foreground">
                <h2 class="text-green-600 dark:text-green-400">
                  v{latestVersion.entry.data.version}
                </h2>
              </div>
              <div>
                <ol class="space-y-6">
                  {versions.map(({ entry, Content }) => {
                    return (
                      <li>
                        <time
                          datetime={entry.data.published.toISOString()}
                          class="text-muted-foreground"
                        >
                          {entry.data.published.toLocaleDateString("en-US", {
                            year: "numeric",
                            month: "short",
                            day: "2-digit",
                          })}
                        </time>
                        <div class="prose mt-1">
                          <Content />
                        </div>
                      </li>
                    );
                  })}
                </ol>
              </div>
            </li>
          );
        })
      }
    </ol>
  </article>
</BaseLayout>
